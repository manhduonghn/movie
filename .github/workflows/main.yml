name: Build Android APK with EAS

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout source code
        uses: actions/checkout@v4

      - name: 🧩 Install dependencies
        run: |
          npm install -g eas-cli

      - name: 🔐 Authenticate with Expo Token
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "✅ Expo token loaded"

      - name: ⚙️ Auto-detect or create Expo project
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          OWNER="timie"    # 👈 sửa theo username trên expo.dev
          SLUG=$(jq -r '.expo.slug // empty' app.json)
          if [ -z "$SLUG" ]; then
            echo "⚠️ app.json chưa có slug, dùng tên thư mục làm slug"
            SLUG=$(basename "$PWD")
          fi
          echo "📄 App slug: $SLUG"

          API_URL="https://api.expo.dev/v2/projects/@$OWNER/$SLUG"

          echo "🔍 Gọi API: $API_URL"
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $EXPO_TOKEN" -H "Accept: application/json" "$API_URL")

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "🌐 HTTP Status: $STATUS"
          echo "📦 Raw response:"
          echo "$BODY"

          # Nếu API trả lỗi (ví dụ 401 hoặc 404)
          if [ "$STATUS" = "401" ]; then
            echo "❌ Lỗi: Token Expo không hợp lệ hoặc hết hạn."
            exit 1
          fi

          if [ "$STATUS" = "404" ]; then
            echo "🚀 Project chưa tồn tại. Tạo mới..."
            CREATE_JSON=$(curl -s -X POST \
              -H "Authorization: Bearer $EXPO_TOKEN" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -d "{\"accountName\": \"$OWNER\", \"slug\": \"$SLUG\"}" \
              "https://api.expo.dev/v2/projects")

            echo "📦 Kết quả tạo mới:"
            echo "$CREATE_JSON"

            PROJECT_ID=$(echo "$CREATE_JSON" | jq -r '.data.id // empty')
            if [ -z "$PROJECT_ID" ]; then
              echo "❌ Không thể tạo project. JSON không hợp lệ."
              exit 1
            fi
            echo "✅ Đã tạo project mới: $PROJECT_ID"
          else
            # Nếu API trả về JSON hợp lệ
            PROJECT_ID=$(echo "$BODY" | jq -r '.data.id // empty' 2>/dev/null || true)
            if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
              echo "⚠️ Không đọc được projectId từ JSON, có thể lỗi API."
              echo "$BODY"
              exit 1
            fi
            echo "✅ Project đã tồn tại: $PROJECT_ID"
          fi

          # 🧩 Chèn projectId vào app.json
          tmp=$(mktemp)
          jq ".expo += {\"owner\": \"$OWNER\", \"projectId\": \"$PROJECT_ID\"}" app.json > "$tmp"
          mv "$tmp" app.json
          echo "📄 app.json sau khi cập nhật:"
          cat app.json

      - name: 🧱 Build Android APK (EAS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_SKIP_AUTO_FINGERPRINT: 1
        run: |
          eas build --platform android --profile preview --non-interactive

      - name: 📤 Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: eas-build-log
          path: .expo
