name: Build Android APK with EAS

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout source code
        uses: actions/checkout@v4

      - name: ðŸ§© Install dependencies
        run: |
          npm install -g eas-cli

      - name: ðŸ” Authenticate with Expo Token
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "âœ… Expo token loaded"

      - name: âš™ï¸ Auto-detect or create Expo project
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          OWNER="timie"    # ðŸ‘ˆ sá»­a theo tÃªn tÃ i khoáº£n Expo
          SLUG=$(jq -r '.expo.slug' app.json)
          if [ "$SLUG" = "null" ] || [ -z "$SLUG" ]; then
            echo "âš ï¸ app.json chÆ°a cÃ³ slug, dÃ¹ng tÃªn thÆ° má»¥c lÃ m slug"
            SLUG=$(basename "$PWD")
          fi
          echo "ðŸ“„ App slug: $SLUG"

          # ðŸ” Kiá»ƒm tra xem project Ä‘Ã£ tá»“n táº¡i chÆ°a
          echo "ðŸ” TÃ¬m project @$OWNER/$SLUG trÃªn Expo..."
          PROJECT_JSON=$(curl -s -H "Authorization: Bearer $EXPO_TOKEN" \
            "https://api.expo.dev/v2/projects/@$OWNER/$SLUG")

          PROJECT_ID=$(echo "$PROJECT_JSON" | jq -r '.data.id // empty')

          if [ -z "$PROJECT_ID" ]; then
            echo "ðŸš€ ChÆ°a cÃ³ project, táº¡o má»›i..."
            CREATE_RES=$(curl -s -X POST \
              -H "Authorization: Bearer $EXPO_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"accountName\": \"$OWNER\", \"slug\": \"$SLUG\"}" \
              "https://api.expo.dev/v2/projects")
            PROJECT_ID=$(echo "$CREATE_RES" | jq -r '.data.id // empty')
            if [ -z "$PROJECT_ID" ]; then
              echo "âŒ KhÃ´ng thá»ƒ táº¡o project. Xem JSON tráº£ vá»:"
              echo "$CREATE_RES"
              exit 1
            fi
            echo "âœ… ÄÃ£ táº¡o project má»›i: $PROJECT_ID"
          else
            echo "âœ… Project Ä‘Ã£ tá»“n táº¡i: $PROJECT_ID"
          fi

          # ðŸ§© ChÃ¨n projectId vÃ o app.json
          tmp=$(mktemp)
          jq ".expo += {\"owner\": \"$OWNER\", \"projectId\": \"$PROJECT_ID\"}" app.json > "$tmp"
          mv "$tmp" app.json
          echo "ðŸ“„ app.json sau khi cáº­p nháº­t:"
          cat app.json

      - name: ðŸ§± Build Android APK (EAS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_SKIP_AUTO_FINGERPRINT: 1
        run: |
          eas build --platform android --profile preview --non-interactive

      - name: ðŸ“¤ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: eas-build-log
          path: .expo
