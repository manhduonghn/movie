name: Build Android APK with EAS

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout source code
        uses: actions/checkout@v4

      - name: ðŸ§© Install dependencies
        run: |
          npm install -g eas-cli

      - name: ðŸ” Authenticate with Expo Token
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "âœ… Expo token loaded"

      - name: âš™ï¸ Auto-detect or create Expo project
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          OWNER="timie"    # ðŸ‘ˆ sá»­a theo username trÃªn expo.dev
          SLUG=$(jq -r '.expo.slug // empty' app.json)
          if [ -z "$SLUG" ]; then
            echo "âš ï¸ app.json chÆ°a cÃ³ slug, dÃ¹ng tÃªn thÆ° má»¥c lÃ m slug"
            SLUG=$(basename "$PWD")
          fi
          echo "ðŸ“„ App slug: $SLUG"

          API_URL="https://api.expo.dev/v2/projects/@$OWNER/$SLUG"

          echo "ðŸ” Gá»i API: $API_URL"
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $EXPO_TOKEN" -H "Accept: application/json" "$API_URL")

          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "ðŸŒ HTTP Status: $STATUS"
          echo "ðŸ“¦ Raw response:"
          echo "$BODY"

          # Náº¿u API tráº£ lá»—i (vÃ­ dá»¥ 401 hoáº·c 404)
          if [ "$STATUS" = "401" ]; then
            echo "âŒ Lá»—i: Token Expo khÃ´ng há»£p lá»‡ hoáº·c háº¿t háº¡n."
            exit 1
          fi

          if [ "$STATUS" = "404" ]; then
            echo "ðŸš€ Project chÆ°a tá»“n táº¡i. Táº¡o má»›i..."
            CREATE_JSON=$(curl -s -X POST \
              -H "Authorization: Bearer $EXPO_TOKEN" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -d "{\"accountName\": \"$OWNER\", \"slug\": \"$SLUG\"}" \
              "https://api.expo.dev/v2/projects")

            echo "ðŸ“¦ Káº¿t quáº£ táº¡o má»›i:"
            echo "$CREATE_JSON"

            PROJECT_ID=$(echo "$CREATE_JSON" | jq -r '.data.id // empty')
            if [ -z "$PROJECT_ID" ]; then
              echo "âŒ KhÃ´ng thá»ƒ táº¡o project. JSON khÃ´ng há»£p lá»‡."
              exit 1
            fi
            echo "âœ… ÄÃ£ táº¡o project má»›i: $PROJECT_ID"
          else
            # Náº¿u API tráº£ vá» JSON há»£p lá»‡
            PROJECT_ID=$(echo "$BODY" | jq -r '.data.id // empty' 2>/dev/null || true)
            if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
              echo "âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c projectId tá»« JSON, cÃ³ thá»ƒ lá»—i API."
              echo "$BODY"
              exit 1
            fi
            echo "âœ… Project Ä‘Ã£ tá»“n táº¡i: $PROJECT_ID"
          fi

          # ðŸ§© ChÃ¨n projectId vÃ o app.json
          tmp=$(mktemp)
          jq ".expo += {\"owner\": \"$OWNER\", \"projectId\": \"$PROJECT_ID\"}" app.json > "$tmp"
          mv "$tmp" app.json
          echo "ðŸ“„ app.json sau khi cáº­p nháº­t:"
          cat app.json

      - name: ðŸ§± Build Android APK (EAS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_SKIP_AUTO_FINGERPRINT: 1
        run: |
          eas build --platform android --profile preview --non-interactive

      - name: ðŸ“¤ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: eas-build-log
          path: .expo
